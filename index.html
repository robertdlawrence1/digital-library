<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Reading Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        h1 {
            margin-bottom: 20px;
        }

        .filter-container {
            margin-bottom: 20px;
        }

        /* Horizontal scrolling shelf */
        .shelf-container {
            display: flex;
            overflow-x: auto;
            padding: 20px;
            gap: 15px;
            white-space: nowrap;
            scroll-behavior: smooth;
            min-height: 320px;
            align-items: flex-end;
            background-color: #e0e0e0;
            border-radius: 5px;
        }

        /* Book spine */
        .book {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 2px 5px 5px 2px;
            height: 250px;
            text-align: center;
            transition: all 0.3s ease-in-out;
            background: white;
            overflow: hidden;
            position: relative;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }

        /* Title wraps inside the book spine */
        .book-title {
            font-weight: bold;
            text-align: center;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            word-wrap: break-word;
            overflow: hidden;
            white-space: normal;
            width: 100%;
            max-height: 65%;
            padding: 5px;
            line-height: 1.2;
        }

        /* Author wraps properly at the bottom */
        .book-author {
            font-size: 0.9em;
            color: gray;
            text-align: center;
            white-space: normal;
            word-wrap: break-word;
            overflow: hidden;
            width: 100%;
            margin-top: 10px;
            line-height: 1.2;
        }

        /* Hover Effect */
        .book:hover {
            width: 300px !important; /* Uniform expanded width */
            height: 300px; /* Expanded height */
            position: relative;
            z-index: 10;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.2);
        }

        /* Book Details in Hover View */
        .book-content {
            display: none;
            font-size: 0.9em;
            text-align: left;
            padding: 10px;
            overflow: hidden;
            max-height: 100%;
            text-overflow: ellipsis;
            white-space: normal;
        }

        /* When hovered, show description */
        .book:hover .book-content {
            display: block;
        }

        .book:hover .book-title, .book:hover .book-author {
            display: none;
        }

        /* Book metadata */
        .book-metadata {
            font-size: 0.85em;
            color: #666;
            margin: 5px 0;
        }

        /* Book summary */
        .book-summary {
            font-size: 0.9em;
            margin-top: 10px;
            line-height: 1.4;
            max-height: 150px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>My Reading Tracker</h1>
    <div class="filter-container">
        <label for="filter">Filter by Topic:</label>
        <select id="filter">
            <option value="all">All</option>
        </select>
    </div>
    <div class="shelf-container" id="bookshelf"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAC2xKlseyouk18Dr8A-ocoqY77OP56Jtk",
            authDomain: "digital-library-4f53e.firebaseapp.com",
            projectId: "digital-library-4f53e",
            storageBucket: "digital-library-4f53e.appspot.com",
            messagingSenderId: "775289018267",
            appId: "1:775289018267:web:86ea3e5cad787a2a0e733e",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allBooks = [];

        async function fetchBooks() {
            try {
                const booksCollection = collection(db, "books");
                const booksSnapshot = await getDocs(booksCollection);
                allBooks = booksSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (allBooks.length === 0) {
                    console.warn("No books found in Firestore.");
                    // Add a placeholder message if no books found
                    document.getElementById("bookshelf").innerHTML = 
                        '<div class="no-books">No books found in your library. Add some books to get started!</div>';
                }

                // Extract unique topics from contentTags
                const topics = new Set();
                allBooks.forEach(book => {
                    if (book.contentTags && Array.isArray(book.contentTags)) {
                        book.contentTags.forEach(tag => topics.add(tag));
                    }
                });

                populateFilter([...topics]);
                displayBooks(allBooks);
            } catch (error) {
                console.error("Error fetching books:", error);
                document.getElementById("bookshelf").innerHTML = 
                    '<div class="error">Error loading books. Please check your connection and try again.</div>';
            }
        }

        function populateFilter(tags) {
            const filterDropdown = document.getElementById("filter");
            filterDropdown.innerHTML = '<option value="all">All</option>';

            tags.sort().forEach(tag => {
                const option = document.createElement("option");
                option.value = tag;
                option.textContent = tag;
                filterDropdown.appendChild(option);
            });

            filterDropdown.addEventListener("change", (event) => {
                filterBooks(event.target.value);
            });
        }

        function filterBooks(selectedTag) {
            let filteredBooks = allBooks;

            if (selectedTag !== "all") {
                filteredBooks = allBooks.filter(book =>
                    book.contentTags && book.contentTags.includes(selectedTag)
                );
            }

            displayBooks(filteredBooks);
        }

        function displayBooks(books) {
            const bookshelf = document.getElementById("bookshelf");
            bookshelf.innerHTML = "";

            books.forEach(book => {
                const bookDiv = document.createElement("div");
                bookDiv.classList.add("book");

                // Calculate book width based on page count
                // Formula: base width + scaled page count, with min/max constraints
                const pageCount = book.pageCount ? book.pageCount : 200; // Default if no page count
                // Ensure width scales reasonably with page count
                // More pages = wider spine, but within reasonable limits
                const minWidth = 40;  // Minimum width for very short books
                const maxWidth = 120; // Maximum width for very long books
                // Scale factor adjusted to create a reasonable curve
                const scaleFactor = 0.05;
                const bookWidth = Math.max(minWidth, Math.min(maxWidth, 
                    minWidth + (Math.log(pageCount) * scaleFactor * pageCount)));
                
                bookDiv.style.width = `${bookWidth}px`;

                // Calculate font size based on spine width
                // Narrower books get smaller text
                const titleFontSize = Math.max(10, Math.min(16, bookWidth / 8));
                const authorFontSize = Math.max(8, Math.min(14, bookWidth / 9));

                // Build the book HTML structure
                const titleDiv = document.createElement("div");
                titleDiv.classList.add("book-title");
                titleDiv.textContent = book.title || "Untitled";
                titleDiv.style.fontSize = `${titleFontSize}px`;
                
                const authorDiv = document.createElement("div");
                authorDiv.classList.add("book-author");
                authorDiv.textContent = book.author || "Unknown Author";
                authorDiv.style.fontSize = `${authorFontSize}px`;
                
                const contentDiv = document.createElement("div");
                contentDiv.classList.add("book-content");
                
                // Build expanded content (shown on hover)
                contentDiv.innerHTML = `
                    <strong>${book.title || "Untitled"}</strong><br>
                    <em>${book.author || "Unknown Author"}</em>
                    <div class="book-metadata">
                        ${book.pageCount ? `${book.pageCount} pages | ` : ""} ${book.yearPublished || "Unknown Year"}
                    </div>
                    <div class="book-summary">
                        ${book.summary || "No summary available."}
                    </div>
                `;
                
                // Assemble the book
                bookDiv.appendChild(titleDiv);
                bookDiv.appendChild(authorDiv);
                bookDiv.appendChild(contentDiv);
                
                bookshelf.appendChild(bookDiv);
            });
        }

        // Initialize the app
        window.addEventListener('DOMContentLoaded', () => {
            fetchBooks();
        });
    </script>
</body>
</html>
