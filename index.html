<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Reading Tracker</title>
  <style>
    /* Base styling */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
      background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
      color: #333;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      transition: background 0.3s ease, color 0.3s ease;
    }
    h1 {
      margin-top: 0;
    }

  /* Theme toggle button */
  .theme-toggle {
    position: absolute;
    top: 20px;
    right: 20px;
    background: #8B4513;
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s, transform 0.3s;
    padding: 0;
  }
  .theme-toggle:hover {
    background: #6B4226;
    transform: rotate(15deg);
  }
  .sun-icon, .moon-icon {
    position: absolute;
    transition: opacity 0.3s, transform 0.5s;
  }
  .sun-icon {
    opacity: 0;
    transform: scale(0.7);
  }
  .moon-icon {
    opacity: 1;
    transform: scale(1);
  }
  body.dark-mode .theme-toggle {
    background: #5a2d0c;
  }
  body.dark-mode .theme-toggle:hover {
    background: #8B4513;
  }
  body.dark-mode .sun-icon {
    opacity: 1;
    transform: scale(1);
  }
  body.dark-mode .moon-icon {
    opacity: 0;
    transform: scale(0.7);
  }
    
    /* Filter buttons */
    .filter-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .filter-button {
      padding: 8px 16px;
      border-radius: 20px;
      border: 2px solid #555;
      background-color: #eee;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s, color 0.2s, border 0.2s;
    }
    .filter-button.selected {
      background-color: currentColor; /* This will be overridden in JavaScript */
      color: #fff;
      border-color: currentColor;
      opacity: 1;
    }

    /* Bookshelf container */
    .shelf-container {
      display: flex;
      overflow-x: auto;
      padding: 20px;
      gap: 10px;
      scroll-behavior: smooth;
      align-items: flex-start;
      background: linear-gradient(to bottom, #e0e0e0, #d1d1d1);
      border-radius: 5px;
      min-height: 550px;
      flex-grow: 1;
      box-shadow: inset 0 5px 15px rgba(0,0,0,0.1);
      margin-top: 10px;
      transition: background 0.3s ease;
    }

    /* Book styling */
    .book {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 400px;       /* Fixed height for the spine */
      border-radius: 4px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.15);
      cursor: pointer;
      padding: 15px;
      position: relative;
      color: #fff;
      text-align: center;
      font-size: 14px;    /* Base font size */
      flex-shrink: 0;
      transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
      /* Spine width is set inline via JS */
    }
    .book:hover {
      transform: translateY(-5px);
      box-shadow: 2px 7px 10px rgba(0,0,0,0.2);
    }

    /****************************************************
     * SPINE TEXT LAYOUT
     * - The spine text container has a top "title zone" (2/3)
     *   and a bottom "author zone" (1/3).
     ****************************************************/
    .book-spine-text {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    /* Title zone (2/3 of the spine).
       Horizontal if <= 50 chars; vertical if > 50. */
    .title-zone {
      flex: 2;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 5px;
      overflow: visible;      /* We'll rely on JS to shrink the text if needed */
      font-family: 'Georgia', serif;
      font-weight: 600;
    }
    /* Horizontal title: normal text flow, wrapping at spaces. */
    .horizontal {
      writing-mode: horizontal-tb;
      white-space: normal;
      word-break: normal;
      overflow-wrap: normal;  /* do not split words */
    }
    /* Vertical title: letters sideways-lr, reading bottom-to-top. */
    .vertical {
      writing-mode: vertical-rl;
      text-orientation: sideways-lr;
      white-space: normal;
      word-break: normal;
      overflow-wrap: normal;
    }

    /* Author zone (1/3 of the spine), always horizontal. */
    .author-zone {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 5px;
      white-space: normal;
      word-break: normal;
      overflow-wrap: normal;
      overflow: visible;
      font-family: 'Helvetica', sans-serif;
      font-weight: 400;
    }

    /* Expanded book details */
    .book-expanded-content {
      display: none;
      text-align: left;
      white-space: normal;
      word-break: normal;
      overflow-wrap: normal;
      max-width: 380px;
      max-height: 360px;
      overflow-y: auto;
    }
    .book.expanded {
      width: 400px !important;
      min-width: 400px !important;
      z-index: 100;
      background: #fff;
      border-radius: 5px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      overflow-y: auto;
      padding: 20px;
      color: #000;
      transform: translateY(0);
    }
    body.dark-mode .book.expanded {
      background: #2d2d2d;
      color: #e0e0e0;
      box-shadow: 0 10px 25px rgba(0,0,0,0.4);
    }
    .book.expanded .book-expanded-content {
      display: block;
    }
    .book.expanded .book-spine-text {
      display: none;
    }
    
    /* Book tags in expanded view */
    .book-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }
    .book-tag {
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 12px;
      color: white;
    }

    /* Message styling */
    .message {
      padding: 20px;
      color: #555;
    }
    
    /* Dark mode styles */
    body.dark-mode {
      background: linear-gradient(to bottom, #121212, #1e1e1e);
      color: #e0e0e0;
    }
    body.dark-mode .shelf-container {
      background: linear-gradient(to bottom, #2d2d2d, #252525);
      box-shadow: inset 0 5px 15px rgba(0,0,0,0.2);
    }
    body.dark-mode .filter-button {
      background-color: #333;
      color: #ddd;
      border-color: #555;
    }
    body.dark-mode .filter-button.selected {
      background-color: #5a2d0c;
      color: #fff;
    }
    body.dark-mode .message {
      color: #bbb;
    }
    body.dark-mode .theme-toggle {
      background: #5a2d0c;
    }
    body.dark-mode .theme-toggle:hover {
      background: #8B4513;
    }
  </style>
</head>
<body>
  <h1>My Reading Tracker</h1>
  <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">
  <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18">
    <path fill="currentColor" d="M12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3zm-7 6h-2v2h2v-2zm-2-6h2v-2h-2v2zm16 6h-2v2h2v-2zm-2-6h2v-2h-2v2zm-2-4h-2v2h2V5zm-8-2h2V1h-2v2zm0 16h2v2h-2v-2z"/>
  </svg>
  <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18">
    <path fill="currentColor" d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/>
  </svg>
</button>
  <div class="filter-container" id="filter-buttons"></div>
  <div class="shelf-container" id="bookshelf"></div>

  <script type="module">
    /****************************************************
     * Firebase Setup
     ****************************************************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAC2xKlseyouk18Dr8A-ocoqY77OP56Jtk",
      authDomain: "digital-library-4f53e.firebaseapp.com",
      projectId: "digital-library-4f53e",
      storageBucket: "digital-library-4f53e.firebasestorage.app",
      messagingSenderId: "775289018267",
      appId: "1:775289018267:web:86ea3e5cad787a2a0e733e",
      measurementId: "G-4BVT6LVMHX"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);

    /****************************************************
     * Application State
     ****************************************************/
    const state = {
      allBooks: [],
      displayedBooks: [],
      activeFilters: [],
      maxFilters: 3,
      isDarkMode: false
    };

    /****************************************************
     * Color Theme System
     ****************************************************/
    const colorSystem = {
      // Map for tag colors - will be populated dynamically
      tagColors: {},
      
      // Colorful palette for tag assignments
      colorPalette: [
        "#3d5a80", // Blue
        "#7d4e57", // Burgundy
        "#41729f", // Steel blue
        "#5e3023", // Brown
        "#354f52", // Forest green
        "#5e548e", // Purple
        "#028090", // Teal
        "#d62828", // Red
        "#4a4e69", // Slate
        "#687864", // Olive
        "#5f0f40", // Wine
        "#9e2a2b", // Crimson
        "#323031", // Dark gray
        "#540b0e", // Dark red
        "#e09f3e", // Gold
        "#335c67"  // Navy
      ],
  
      // Default colors for books with no matching tags
      defaultColors: ["#8B4513", "#A0522D", "#6B4226", "#855E42"],
      
      // Initialize tag colors from available tags
      initializeTagColors(tags) {
        // Reset the tag colors map
        this.tagColors = {};
        
        // Assign colors to tags
        tags.forEach((tag, index) => {
          this.tagColors[tag] = this.colorPalette[index % this.colorPalette.length];
        });
      },
      
      // Generate color for a book based on its tags
      generateBookColor(tags) {
        if (!Array.isArray(tags) || tags.length === 0) {
          return this.defaultColors[Math.floor(Math.random() * this.defaultColors.length)];
        }
        
        // Get colors for this book's tags
        const colors = tags
          .map(tag => this.tagColors[tag])
          .filter(color => color !== undefined);
        
        if (colors.length === 0) {
          return this.defaultColors[Math.floor(Math.random() * this.defaultColors.length)];
        }
        
        if (colors.length === 1) {
          return colors[0];
        }
        
        // For multiple colors, create a gradient
        return `linear-gradient(135deg, ${colors.join(', ')})`;
      },
      
      // Get the color for a specific tag (for filter buttons)
      getTagColor(tag) {
        return this.tagColors[tag] || "#8B4513";
      }
    };

    /****************************************************
     * Theme Management
     ****************************************************/
 function toggleDarkMode() {
  state.isDarkMode = !state.isDarkMode;
  document.body.classList.toggle('dark-mode', state.isDarkMode);
  
  // Update filter button styling
  const filterButtons = document.querySelectorAll('.filter-button');
  filterButtons.forEach(btn => {
    const tag = btn.textContent;
    const tagColor = colorSystem.getTagColor(tag);
    
    if (btn.classList.contains('selected')) {
      // Selected buttons keep their tag color
      btn.style.backgroundColor = tagColor;
      btn.style.color = "#fff";
    } else {
      // Unselected buttons use theme-appropriate styling
      if (state.isDarkMode) {
        btn.style.backgroundColor = "#333";
        btn.style.color = "#ddd";
      } else {
        btn.style.backgroundColor = "#eee";
        btn.style.color = "#333";
      }
      btn.style.borderColor = tagColor;
      btn.style.borderLeft = `6px solid ${tagColor}`;
    }
  });
  
  // Re-render books for dark mode appearance updates
  renderBooks();
}

    /****************************************************
     * Spine Width Calculation
     ****************************************************/
    function calculateSpineWidth(pageCount) {
      const pages = Math.max(1, Number(pageCount) || 200);
      const MIN_WIDTH = 40;
      const MAX_WIDTH = 250;
      const MAX_PAGES = 2000;
      const clampedPages = Math.min(pages, MAX_PAGES);
      const ratio = (clampedPages - 1) / (MAX_PAGES - 1);
      const width = MIN_WIDTH + ratio * (MAX_WIDTH - MIN_WIDTH);
      return Math.round(width);
    }

    /****************************************************
     * fitTextToContainer: Reduce font-size if the content
     * is larger than its container. We keep shrinking until
     * it fits or we hit a minimum font size.
     ****************************************************/
    function fitTextToContainer(el, minFontSize = 8) {
      if (!el) return;
      const container = el.parentElement;
      if (!container) return;

      let fontSize = parseFloat(window.getComputedStyle(el).fontSize);
      for (let i = 0; i < 50; i++) {
        // If the content overflows horizontally or vertically, shrink
        if (
          el.scrollWidth > container.clientWidth ||
          el.scrollHeight > container.clientHeight
        ) {
          if (fontSize <= minFontSize) break;
          fontSize -= 1;
          el.style.fontSize = fontSize + "px";
        } else {
          break;
        }
      }
    }

    /****************************************************
     * Create Book Element
     ****************************************************/
    function createBookElement(book) {
      const bookDiv = document.createElement("div");
      bookDiv.className = "book";

      // Spine width based on page count
      const spineWidth = calculateSpineWidth(book.pageCount);
      bookDiv.style.width = spineWidth + "px";
      bookDiv.style.minWidth = spineWidth + "px";
      
      // Apply tag-based colors
      const bookColor = colorSystem.generateBookColor(book.contentTags);
      bookDiv.style.background = bookColor;

      // Title threshold
      const titleThreshold = 50;
      const isLongTitle = book.title.length > titleThreshold;
      const titleClass = isLongTitle ? "title-zone vertical" : "title-zone horizontal";

      // Build spine
      bookDiv.innerHTML = `
        <div class="book-spine-text">
          <div class="${titleClass}">
            ${book.title}
          </div>
          <div class="author-zone">
            ${book.author}
          </div>
        </div>
        <div class="book-expanded-content">
          <h3>${book.title}</h3>
          <p><em>by ${book.author}</em></p>
          <p>${book.pageCount} pages | ${book.yearPublished || "Unknown"}</p>
          <p>${book.summary || ""}</p>
          <div class="book-tags">
            ${Array.isArray(book.contentTags) ? book.contentTags.map(tag => 
              `<span class="book-tag" style="background-color: ${colorSystem.getTagColor(tag)}">${tag}</span>`
            ).join('') : ''}
          </div>
        </div>
      `;

      // Toggle expanded view
      bookDiv.addEventListener("click", (e) => {
        bookDiv.classList.toggle("expanded");
        if (bookDiv.classList.contains("expanded")) {
          document.querySelectorAll(".book.expanded").forEach(expandedBook => {
            if (expandedBook !== bookDiv) {
              expandedBook.classList.remove("expanded");
            }
          });
        }
        e.stopPropagation();
      });

      return bookDiv;
    }

    /****************************************************
     * Render Books
     ****************************************************/
    function renderBooks() {
      const shelf = document.getElementById("bookshelf");
      shelf.innerHTML = "";

      if (!state.displayedBooks.length) {
        const message = document.createElement("div");
        message.className = "message";
        message.textContent = "No books found matching these filters.";
        shelf.appendChild(message);
        return;
      }

      // Create each book
      state.displayedBooks.forEach(book => {
        const bookElement = createBookElement(book);
        shelf.appendChild(bookElement);
      });

      // After creation, fit text in each zone
      const allBooks = document.querySelectorAll('.book');
      allBooks.forEach(bookEl => {
        const titleEl = bookEl.querySelector('.title-zone');
        const authorEl = bookEl.querySelector('.author-zone');
        fitTextToContainer(titleEl);
        fitTextToContainer(authorEl);
      });

      // Collapse expanded books when clicking outside
      document.addEventListener("click", (e) => {
        if (!e.target.closest(".book")) {
          document.querySelectorAll(".book.expanded").forEach(b => b.classList.remove("expanded"));
        }
      });
    }

    /****************************************************
     * Filter Logic
     ****************************************************/
function createFilterButtons() {
  const container = document.getElementById("filter-buttons");
  container.innerHTML = "";

  // Extract all unique tags from books
  const allTags = new Set();
  state.allBooks.forEach(book => {
    if (Array.isArray(book.contentTags)) {
      book.contentTags.forEach(tag => allTags.add(tag));
    }
  });

  // Sort tags alphabetically
  const sortedTags = Array.from(allTags).sort();
  
  // Initialize color system with all available tags
  colorSystem.initializeTagColors(sortedTags);

  // Create filter buttons
  sortedTags.forEach(tag => {
    const btn = document.createElement("button");
    btn.className = "filter-button";
    btn.textContent = tag;
    
    const tagColor = colorSystem.getTagColor(tag);
    btn.style.borderColor = tagColor;
    btn.style.borderLeft = `6px solid ${tagColor}`;
    
    // Apply proper theme styling
    if (state.isDarkMode) {
      btn.style.backgroundColor = "#333";
      btn.style.color = "#ddd";
    } else {
      btn.style.backgroundColor = "#eee";
      btn.style.color = "#333";
    }
    
    btn.addEventListener("click", () => toggleFilter(tag, btn));
    container.appendChild(btn);
  });
}
    
function toggleFilter(tag, buttonElement) {
  if (state.activeFilters.includes(tag)) {
    // Unselect the filter
    state.activeFilters = state.activeFilters.filter(t => t !== tag);
    buttonElement.classList.remove("selected");
    
    // Reset the button appearance
    buttonElement.style.backgroundColor = state.isDarkMode ? "#333" : "#eee";
    buttonElement.style.color = state.isDarkMode ? "#ddd" : "#333";
    buttonElement.style.borderColor = colorSystem.getTagColor(tag);
    buttonElement.style.borderLeft = `6px solid ${colorSystem.getTagColor(tag)}`;
  } else {
    // Check max filters
    if (state.activeFilters.length >= state.maxFilters) return;
    
    // Select the filter
    state.activeFilters.push(tag);
    buttonElement.classList.add("selected");
    
    // Apply the tag color to the selected button
    const tagColor = colorSystem.getTagColor(tag);
    buttonElement.style.backgroundColor = tagColor;
    buttonElement.style.color = "#fff";
    buttonElement.style.borderColor = tagColor;
  }
  applyFilters();
}
    
    function applyFilters() {
      if (!state.activeFilters.length) {
        state.displayedBooks = [...state.allBooks];
      } else {
        state.displayedBooks = state.allBooks.filter(book =>
          state.activeFilters.every(tag =>
            Array.isArray(book.contentTags) && book.contentTags.includes(tag)
          )
        );
      }
      renderBooks();
    }

    /****************************************************
     * Load Data from Firestore
     ****************************************************/
    async function loadBookData() {
      try {
        document.getElementById("bookshelf").innerHTML =
          "<div class='message'>Loading your book collection...</div>";

        const snapshot = await getDocs(collection(db, "books"));
        state.allBooks = snapshot.docs.map(doc => {
          const data = doc.data();
          return { id: doc.id, ...data };
        });

        console.log("Loaded books:", state.allBooks.map(b => ({
          title: b.title,
          pageCount: b.pageCount
        })));

        state.displayedBooks = [...state.allBooks];
        createFilterButtons();
        renderBooks();

      } catch (error) {
        console.error("Error loading book data:", error);
        document.getElementById("bookshelf").innerHTML =
          "<div class='message'>Error loading books. Please check your connection and try again.</div>";
      }
    }

    /****************************************************
     * Start the Application
     ****************************************************/
    document.addEventListener("DOMContentLoaded", () => {
      // Initialize theme toggle
      const themeToggleBtn = document.getElementById('theme-toggle');
      themeToggleBtn.addEventListener('click', toggleDarkMode);
      
      // Apply initial theme based on user preference
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        toggleDarkMode();
      }
      
      // Load book data from Firestore
      loadBookData();
    });
  </script>
</body>
</html>
